<!DOCTYPE html>
<html>
<head>
  <!--Import Google Icon Font-->
  <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.2/css/materialize.min.css">

  <!--Let browser know website is optimized for mobile-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <link type="text/css" rel="stylesheet" href="css/style.css" />

  <title>Splash in the Flow</title>
</head>

<body>

  <header>
    <div class="container">
      <div class="row">
        <div class="col s12">
         <span class="flow-text">Splash in the Flow</span>
       </div>
     </div>
   </div>
 </header>

  <main>

  <!-- =============== LOGIN ============== -->

   <div class="container" id="splash-login">

      <div class="row">
        <div class="col m4 offset-m4 s12 card card-splash-30">

          <div class="row">
            <div class="col s12 center">
              <span class="flow-text">Como podemos lhe chamar?</span>
            </div>
          </div>

            <div class="row">
              <div class="input-field col s12">
                <input id="login-input-nick" name="nickname" type="text" class="validate">
                <label for="input-nick">Nickname</label>
              </div>
            </div>

            <div class="row">
              <div class="col s12">
                <span class="">Tenho interesse em:</span>
              </div>
              <div class="col m6 s12">
                <p>
                 <input type="checkbox" id="input-java" />
                 <label for="input-java">Java</label>
               </p>
               <p>
                 <input type="checkbox" id="input-python" />
                 <label for="input-python">Python</label>
               </p>
               <p>
                 <input type="checkbox" id="input-css3" />
                 <label for="input-css3">CSS3</label>
               </p>
             </div>

             <div class="col m6 s12">
               <p>
                 <input type="checkbox" id="input-node" />
                 <label for="input-node">Node.js</label>
               </p>
               <p>
                 <input type="checkbox" id="input-ruby" />
                 <label for="input-ruby">Ruby</label>
               </p>
               <p>
                 <input type="checkbox" id="input-android" />
                 <label for="input-android">Android</label>
               </p>
             </div>
           </div>

           <div class="col s12 center margin-top-10">
             <button id="login-start" class="btn waves-effect waves-light" type="submit" name="action">Começar</button>
           </div>

       </div>
     </div>

   </div>

   <!--============ DISCUSSIONS ============== -->

   <div class="container" id="splash-discussions">

      <div class="row">
        <div class="col m8 offset-m2 s12 card card-splash-30">

          <div class="row">
            <div class="col s12 center">
              <span class="flow-text">Discussões em andamento</span>
            </div>
          </div>

          <div class="row">
            <div class="col s12">
              <div id="discussions-list" class="collection">
              </div>
            </div>
          </div>
      </div>
    </div>

      </div>

      <div class="fixed-action-btn">
        <a href="#new-discussion" class="btn-floating btn-large waves-effect waves-light tooltipped" data-position="left" data-delay="50" data-tooltip="Nova Discussão">
         <i class="large material-icons">add</i>
       </a>
     </div>

     <!-- Modal Structure -->
     <div id="new-discussion" class="modal modal-fixed-footer">
      <div class="modal-content">
        <div class="row">
          <div class="col s12">
            <span class="flow-text">Nova Discussão</span>
          </div>
        </div>
        <div class="row">
          <div class="input-field col s12">
            <input id="new-discussion-title" type="text" class="validate">
            <label for="new-discussion-title">Título</label>
          </div>
        </div>
        <div class="row">
          <div class="input-field col s12">
            <select id="new-discussion-preferences" multiple>
              <option value="" disabled selected>Escolha os tópicos relacionados</option>
              <option value="1">Java</option>
              <option value="2">Android</option>
              <option value="3">Ruby</option>
              <option value="3">Ruby</option>
              <option value="3">Ruby</option>
              <option value="3">Ruby</option>
              <option value="3">Ruby</option>
              <option value="3">Ruby</option>
              <option value="3">Ruby</option>
              <option value="3">Ruby</option>
              <option value="3">Ruby</option>
              <option value="3">Ruby</option>
            </select>
            <label>Tópicos</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="col s12 center">
          <a id="new-discussion-submit" href="#!" class="modal-action modal-close waves-effect waves-green btn-flat">Iniciar Discussão</a>
        </div>
      </div>
    </div>

    <!-- ============== ROOM ============= -->


    <div class="container" id="splash-room">

      <div class="row">
        <div class="col m10 offset-m1 s12">

          <div class="row">
            <div class="col s12 center">
              <span class="flow-text" id="room-title"></span>
            </div>
          </div>

          <div class="row" style="height: 320px">

            <div class="col s9 card room" id="room-chat">
            </div>

            <div class="col s3 card room">
              <p>Geyson Daniel</p>
            </div>

          </div>

          <div class="row card card-splash-15">
            <div class="input-field col s12">
            <input onkeypress="sendMessage(event)" placeholder="Digite sua mensagem..." id="room-msg" type="text">
            </div>
          </div>

        </div>
      </div>

    </div>

  </main>

<!--Import jQuery before materialize.js-->
<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<!-- Compiled and minified JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.2/js/materialize.min.js"></script>

<script>
 $(document).ready(function() {
   $('.modal').modal();
   $('select').material_select();
 });
</script>

<script src="http://requirejs.org/docs/release/2.3.3/minified/require.js"></script>

<script>
   var ws = new WebSocket('ws://192.168.0.150:3000/splash');

   var nickname;
   var topic;

   ws.onopen = function() {
      //ws.send('something');
   }

   ws.onmessage = function(e) {
      if (e.data.includes('mqtt')) {
         var protocol = e.data.split(";");
         if (topic == protocol[1]) {
            addMessageToChat(protocol[2]);
            updateScroll();
         }
      } else if(e.data.includes('sitf-topics-return')) {

         document.getElementById("discussions-list").innerHTML = '';
       
          var protocol = e.data.split(";");
          protocol.shift();
          protocol = protocol.toString().split(',');

          for (var i = 0; i < protocol.length; i++) {
            if (!protocol[i] == '') {
               document.getElementById("discussions-list").innerHTML += '<a href="#!" class="collection-item"><span class="new badge" data-badge-caption="">SI</span><span class="discussion-topic">' + protocol[i] + '</span></a>'
            }
          }

            $('.collection-item').click(function() {
               goRoom($(this).children().eq(1).text());
            });

      } else if (e.data.includes('sitf-login-return')) {
         goDiscussions();
      }
   }

   function addMessageToChat(message) {
      document.getElementById("room-chat").innerHTML += message + "<br>";
   }
   
   ws.onclose = function() {
      alert('close');
   }

   $('#login-start').click(function() {
      var nick = $('#login-input-nick').val();
      nickname = nick;
      var protocol = 'sitf-login;' + nick;
      ws.send(protocol);
   });

   $('#new-discussion-submit').click(function() {
      var title = $('#new-discussion-title').val();
      goRoom(title);
   });

   function goDiscussions() {
      ws.send("sitf-topics");
      $('#splash-login').css('display', 'none');
      $('#splash-discussions').css('display', 'block');
   }

   function goRoom(t) {
      topic = 'sitf-' + t;
      var protocol = "sitf-subscribe;" + topic;
      ws.send(protocol);
      $('#splash-discussions').css('display', 'none');
      $('#splash-room').css('display', 'block');
      $('#room-title').text(t);
   }

   function sendMessage(event) {
      var x = event.keyCode;
      if (x == 13) {
         ws.send('sitf-publish;'+ topic + ';' + $('#room-msg').val());
         $('#room-msg').val("");
      }
   }

   function updateScroll(){
    var element = document.getElementById("room-chat");
    element.scrollTop = element.scrollHeight;
   }
  

</script>

</body>
</html>